<html>
<head>
<meta charset="UTF-8">
<title>Correspondance entre FANTOIR et voies OSM</title>
<script src="jquery-2.1.1.min.js"></script>
<style>
	body{
	    font-family: monospace;
	}
	#rubriques{
		position:absolute;
		top:110px;
	}
	#reponse{
		position:absolute;
		top:170px;
	}
	.rubrique{
		cursor:pointer;
		width:150px;
		height:50px;
		position:relative;
		float:left;
		color:black;
		font-weight: bold;
		background:white;
		margin:1px solid grey;
	}
	.rubrique.active{
		border:3px solid black;
	}
	.table_liste{
		display:none;
	}
	.zone_click{
		cursor:pointer;
		color:blue;
		text-decoration: underline;
	}
	.zone_click.clicked{
		background-color:green;
		color:white;
	}
	#table_voies_non_match .cell_fantoir,#rub_voies_non_match.active{
		background:lightgrey;
	}
	#table_voies_match .cell_fantoir,#rub_voies_match.active{
		background:lightgreen;
	}
</style>
<script>
	function requete_fantoir(){
		$('#table_voies_non_match').empty()
		$('#table_voies_match').empty()
		$.ajax({
			url: "requete_fantoir.py?insee="+$('#input_insee')[0].value
		})
		.done(function( data ) {
			nom_commune = data[0][0]
			voies_fantoir_adresses_non_match = data[1]
			voies_fantoir_adresses_match = data[2]
			document.title = nom_commune+' - Correspondance entre FANTOIR et voies OSM'
			$('#bandeau_commune').empty().append(nom_commune)
			
			$('#rub_voies_non_match').empty().text(voies_fantoir_adresses_non_match.length+" voies FANTOIR avec adresses sans rapprochement OSM")
			$('#rub_voies_match').empty().text(voies_fantoir_adresses_match.length+" voies FANTOIR avec adresses et rapprochement OSM")
			$('#table_voies_non_match').append($('<tr>').append($('<th>').append('Code FANTOIR')))
			$('#table_voies_non_match tr').append($('<th>').append('Voie FANTOIR'))
//			$('#table_voies_non_match tr').append($('<th>').append('Voie OSM'))
			$('#table_voies_non_match tr').append($('<th>').attr('colspan','3').append('Cartes'))
			$('#table_voies_non_match tr').append($('<th>').attr('colspan','3').append('Ã‰dition'))
			$('#table_voies_match').append($('<tr>').append($('<th>').append('Code FANTOIR')))
			$('#table_voies_match tr').append($('<th>').append('Voie FANTOIR'))
			$('#table_voies_match tr').append($('<th>').append('Voie OSM'))
			
			for (l=0;l<voies_fantoir_adresses_non_match.length;l++){
				url_map_org_part1 = 'http://www.openstreetmap.org/'
				url_map_fr_part1 = 'http://tile.openstreetmap.fr/'
				url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
				url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
				url_ol_part2 = '?zoom=18&lat='+voies_fantoir_adresses_non_match[l][4]+'&lon='+voies_fantoir_adresses_non_match[l][3]
				url_hash_coords = '18/'+voies_fantoir_adresses_non_match[l][4]+'/'+voies_fantoir_adresses_non_match[l][3]
				delta = 0.0005
				xleft  = voies_fantoir_adresses_non_match[l][3]-delta
				xright = voies_fantoir_adresses_non_match[l][3]+delta
				ybottom = voies_fantoir_adresses_non_match[l][4]-delta
				ytop = voies_fantoir_adresses_non_match[l][4]+delta
			//Fantoir
				$('#table_voies_non_match').append($('<tr>').append($('<td>').addClass('cell_fantoir').text(voies_fantoir_adresses_non_match[l][0])))
			//Nom
				$('#table_voies_non_match tr:last').append($('<td>').text(voies_fantoir_adresses_non_match[l][1]))
//Vide				$('#table_voies_non_match tr:last').append($('<td>').text(voies_fantoir_adresses_non_match[l][2]))
			//.org
				$('#table_voies_non_match tr:last').append($('<td>')
													.append($('<a>')
													.attr('href',url_map_org_part1+'#map='+url_hash_coords)
													.attr('target','blank')
													.text('ORG')))
			//.fr
				$('#table_voies_non_match tr:last').append($('<td>')
													.append($('<a>')
													.attr('href',url_map_fr_part1+url_ol_part2)
													.attr('target','blank')
													.text('FR')))
			//bano
				$('#table_voies_non_match tr:last').append($('<td>')
													.append($('<a>')
													.attr('href',url_bano_part1+'#'+url_hash_coords)
													.attr('target','blank')
													.text('BANO')))
			//JOSM
				$('#table_voies_non_match tr:last').append($('<td>')
													.addClass('zone_click')
													.attr('xleft',xleft).attr('xright',xright).attr('ybottom',ybottom).attr('ytop',ytop)
													.text('JOSM')
													.click(function(){
					srcLoadAndZoom = 'http://127.0.0.1:8111/load_and_zoom?left='+$(this).attr('xleft')+'&right='+$(this).attr('xright')+'&top='+$(this).attr('ytop')+'&bottom='+$(this).attr('ybottom');
					$('<img>').appendTo($('#josm_target')).attr('src',srcLoadAndZoom);
					$(this).addClass('clicked');
				}))
			//ID
				$('#table_voies_non_match tr:last').append($('<td>')
													.append($('<a>')
													.attr('href',url_edit_part1+'id#map='+url_hash_coords)
													.attr('target','blank')
													.text('ID')))
			//Potlatch
				$('#table_voies_non_match tr:last').append($('<td>')
													.append($('<a>')
													.attr('href',url_edit_part1+'potlatch2#map='+url_hash_coords)
													.attr('target','blank')
													.text('P2')))
			}
			for (l=0;l<voies_fantoir_adresses_match.length;l++){
				$('#table_voies_match').append($('<tr>').append($('<td>').addClass('cell_fantoir').text(voies_fantoir_adresses_match[l][0])))
				$('#table_voies_match tr:last').append($('<td>').text(voies_fantoir_adresses_match[l][1]))
				$('#table_voies_match tr:last').append($('<td>').text(voies_fantoir_adresses_match[l][2]))
			}
		//	var e = jQuery.Event( "mouseenter");
			var e = jQuery.Event( "click");
			jQuery($('#rub_voies_non_match').trigger(e))
			window.location.hash="#insee="+$('#input_insee')[0].value
		})
	};
	function start(){
//		$('.rubrique').mouseenter(function() {
		$('.rubrique').click(function() {
			$('.rubrique').removeClass('active');
			$(this).addClass('active');
			$('.table_liste').css({display:'none'})
			$('#'+$(this).attr('cible')).css({display:'block'})
		})
		insee = check_url_for_insee()
		if (insee){
			$('#input_insee').empty()
			$('#input_insee')[0].value = insee
			requete_fantoir()
		}
	};
	function check_url_for_insee(){
		pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
		var res
		if (window.location.hash){
			if (window.location.hash.split('insee=')[1]){
				if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
					res = window.location.hash.split('insee=')[1].split('&')[0]
				} else {
					alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
				}
			}
		}
		return res
	}

</script>
</head>
<body onload="start()">
<form action="javascript:requete_fantoir()">
<input id="input_insee" placeholder="Code INSEE"></input>
<input type="submit" value="Lister">
</form>

<div id="rubriques">
<div class="rubrique" id="rub_voies_non_match" cible="table_voies_non_match"></div>
<div class="rubrique" id="rub_voies_match" cible="table_voies_match"></div>
<!--div id="rub_places_non_match" class="rubrique"></div-->
<!--div id="rub_places_match" class="rubrique"></div-->
</div>
<h1 id='bandeau_commune'></h1>
<div id="reponse">
<table id="table_voies_non_match" class="table_liste">
</table>
<table id="table_voies_match" class="table_liste">
</table>
</div>
<div id="josm_target" style="visibility : hidden"></div>
</body>
</html>
